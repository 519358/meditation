<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>Meditation Bell</title>
  <style>
    :root{
      --bg:#0b0f14;--panel:#11171f;--muted:#8aa0b2;--text:#eef4f8;--accent:#4cc9f0;--good:#7ae582;--warn:#ffd166;--bad:#ff6b6b;
      --shadow: 0 10px 30px rgba(0,0,0,.35);
    }
    html,body{height:100%;}
    body{margin:0;background:linear-gradient(180deg,#0b0f14,#0c1117);color:var(--text);font-family:system-ui,-apple-system,"Hiragino Kaku Gothic ProN","ãƒ’ãƒ©ã‚®ãƒè§’ã‚´ ProN W3",Segoe UI,Roboto,Helvetica,Arial,"Noto Sans JP",sans-serif;}
    .wrap{max-width:980px;margin:0 auto;padding:20px 16px 80px;}
    header{display:flex;gap:12px;align-items:center;justify-content:space-between;margin:8px 0 16px;}
    h1{font-size:24px;letter-spacing:.2px;margin:0;}
    .badge{font-size:12px;color:var(--muted)}
    .card{background:linear-gradient(180deg,rgba(255,255,255,.02),rgba(255,255,255,.01));border:1px solid rgba(255,255,255,.06);border-radius:18px;box-shadow:var(--shadow);}
    .row{display:flex;flex-wrap:wrap;gap:14px}
    .col{flex:1 1 320px;min-width:280px}
    .panel{padding:16px 16px 18px}
    .panel h2{margin:0 0 10px;font-size:16px;color:#cfe6f6;font-weight:700}
    label{display:block;font-size:12px;color:var(--muted);margin:8px 0 6px}
    input,select,button,textarea{font:inherit}
    input[type="text"],input[type="number"],select{width:100%;background:#0e141b;color:var(--text);border:1px solid rgba(255,255,255,.08);border-radius:12px;padding:10px 12px;outline:none}
    input:focus,select:focus{border-color:var(--accent)}
    .btn{display:inline-flex;align-items:center;gap:8px;border:1px solid rgba(255,255,255,.08);background:#0e141b;color:var(--text);padding:10px 14px;border-radius:12px;cursor:pointer}
    .btn:active{transform:translateY(1px)}
    .btn.primary{background:linear-gradient(180deg,#1a2a3a,#152231);border-color:#234;}
    .btn.accent{background:linear-gradient(180deg,#0e1e2c,#0a1a25);border-color:#2a3950;color:#bde9ff}
    .btn.good{background:linear-gradient(180deg,#14301e,#0f2617);border-color:#1f4d2f;color:#c7ffd7}
    .btn.warn{background:linear-gradient(180deg,#362d13,#2b240f);border-color:#51451a;color:#ffefc1}
    .btn.danger{background:linear-gradient(180deg,#3a1616,#2d1111);border-color:#5a1f1f;color:#ffd6d6}
    .btn.small{padding:8px 10px;border-radius:10px;font-size:13px}
    .btn.block{width:100%;justify-content:center}
    .controls{display:flex;flex-wrap:wrap;gap:8px}
    .chips{display:flex;flex-wrap:wrap;gap:8px;margin-top:8px}
    .chip{background:#0f1720;border:1px solid rgba(255,255,255,.07);padding:8px 10px;border-radius:999px;font-size:12px;color:#c9d7e3}
    .list{display:flex;flex-direction:column;gap:10px;margin-top:8px}
    .item{display:flex;align-items:center;justify-content:space-between;gap:10px;padding:10px 12px;background:#0e141b;border:1px solid rgba(255,255,255,.07);border-radius:12px}
    .item small{color:var(--muted)}
    .time-inputs{display:flex;gap:8px}
    .time-inputs input{width:90px}
    .hr{height:1px;background:linear-gradient(90deg,transparent,rgba(255,255,255,.08),transparent);margin:12px 0}
    .status{display:flex;align-items:center;gap:8px;font-size:13px;color:var(--muted)}
    .pill{padding:6px 10px;border-radius:999px;border:1px solid rgba(255,255,255,.08);background:#0e141b}
    .timer{font-feature-settings:"tnum" 1, "ss01" 1; font-variant-numeric:tabular-nums;}
    .big{font-size:44px;letter-spacing:1px}
    footer{position:fixed;left:0;right:0;bottom:0;padding:12px 16px;background:linear-gradient(180deg,rgba(0,0,0,0),rgba(0,0,0,.6));backdrop-filter:blur(6px)}
    .foot{max-width:980px;margin:0 auto;display:flex;gap:10px}
    .foot .btn{flex:1}
    .hint{font-size:12px;color:var(--muted);margin-top:8px}
    .kbd{font-family:ui-monospace,SFMono-Regular,Menlo,Consolas,monospace;background:#0f1720;border:1px solid rgba(255,255,255,.12);border-radius:6px;padding:1px 6px}
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <div>
        <h1>ğŸ§˜â€â™‚ï¸ Meditation Bell</h1>
        <div class="badge">iPhoneãƒ­ãƒ¼ã‚«ãƒ«å®Ÿè¡Œ / ã‚ªãƒ•ãƒ©ã‚¤ãƒ³å¯¾å¿œï¼ˆéŸ³ã¯ã‚¿ãƒƒãƒ—ã§è§£ç¦ï¼‰</div>
      </div>
      <div class="status"><span class="pill" id="audioState">ğŸ”’ Audio locked</span><span class="pill" id="wakeLockState">ğŸŒ™ Auto-Lock æœªé˜²æ­¢</span></div>
    </header>

    <div class="row">
      <div class="col">
        <div class="card panel">
          <h2>1) ãƒ™ãƒ«äºˆå®šï¼ˆã‚ªãƒ•ã‚»ãƒƒãƒˆ/çµ¶å¯¾æ™‚åˆ»ï¼‰</h2>
          <label>ã‚ªãƒ•ã‚»ãƒƒãƒˆè¿½åŠ ï¼ˆé–‹å§‹ã‹ã‚‰ï¼‰</label>
          <div class="controls">
            <div class="time-inputs">
              <input id="mm" type="number" min="0" step="1" placeholder="åˆ†"/>
              <input id="ss" type="number" min="0" max="59" step="1" placeholder="ç§’"/>
            </div>
            <button class="btn small accent" id="addOffset">ï¼‹ è¿½åŠ </button>
            <button class="btn small" id="genEvery">âŸ³ ç­‰é–“éš” ç”Ÿæˆ</button>
          </div>
          <div class="hint">ä¾‹ï¼š<span class="kbd">3</span> åˆ† <span class="kbd">0</span> ç§’ â†’ é–‹å§‹ã‹ã‚‰3åˆ†å¾Œã«é³´å‹•ã€‚ç­‰é–“éš”ã¯ã€Œé–“éš”(åˆ†)ãƒ»å›æ•°ã€æŒ‡å®šã€‚</div>

          <div class="hr"></div>
          <label>çµ¶å¯¾æ™‚åˆ»ï¼ˆä»Šæ—¥ã®æ™‚è¨ˆï¼‰è¿½åŠ </label>
          <div class="controls">
            <input id="absTime" type="time" />
            <button class="btn small accent" id="addAbs">ï¼‹ è¿½åŠ </button>
          </div>
          <div class="hint">ä¾‹ï¼š<span class="kbd">06:30</span> ã®ã‚ˆã†ã«å…¥åŠ›ã™ã‚‹ã¨ã€æœ¬æ—¥ã®ãã®æ™‚åˆ»ã«é³´å‹•ã€‚</div>

          <div class="hr"></div>
          <div>
            <div class="list" id="scheduleList"></div>
            <div class="controls" style="margin-top:8px">
              <button class="btn small" id="clearSchedule">ã‚¯ãƒªã‚¢</button>
              <button class="btn small" id="sortSchedule">æ™‚åˆ»é †ã«ä¸¦ã¹æ›¿ãˆ</button>
              <button class="btn small" id="testBell">ğŸ”” ãƒ†ã‚¹ãƒˆ</button>
            </div>
          </div>
        </div>
      </div>

      <div class="col">
        <div class="card panel">
          <h2>2) ãƒ—ãƒªã‚»ãƒƒãƒˆä¿å­˜ / èª­è¾¼</h2>
          <label>ãƒ—ãƒªã‚»ãƒƒãƒˆå</label>
          <input id="presetName" type="text" placeholder="ä¾‹ï¼šæœ5åˆ†åç¦… + çµ‚äº†3é˜"/>
          <div class="controls" style="margin-top:8px">
            <button class="btn small good" id="savePreset">ğŸ’¾ ä¿å­˜</button>
            <button class="btn small" id="exportPreset">â¤“ ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ</button>
            <label class="btn small" for="importFile">â¤’ ã‚¤ãƒ³ãƒãƒ¼ãƒˆ<input id="importFile" type="file" accept="application/json" style="display:none"></label>
          </div>
          <div class="list" id="presetList"></div>
          <div class="hint">ãƒ—ãƒªã‚»ãƒƒãƒˆã¯iPhoneã®ãƒ–ãƒ©ã‚¦ã‚¶å†…ï¼ˆã‚ªãƒ•ãƒ©ã‚¤ãƒ³å¯ï¼‰ã«ä¿å­˜ã•ã‚Œã¾ã™ã€‚ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆã§JSONã‚’Filesã«ä¿å­˜å¯èƒ½ã€‚</div>
        </div>
      </div>
    </div>

    <div class="row" style="margin-top:14px">
      <div class="col">
        <div class="card panel">
          <h2>3) ã‚»ãƒƒã‚·ãƒ§ãƒ³</h2>
          <div class="timer big" id="clock">00:00</div>
          <div class="chips" id="nextBellInfo"></div>
          <div class="controls" style="margin-top:10px">
            <button class="btn primary" id="unlockAudio">ğŸ”“ éŸ³ã‚’è§£ç¦</button>
            <button class="btn good" id="start">â–¶ é–‹å§‹</button>
            <button class="btn warn" id="pause">â¸ ä¸€æ™‚åœæ­¢</button>
            <button class="btn danger" id="stop">â–  åœæ­¢</button>
          </div>
          <div class="hint">iOSã§ã¯ç”»é¢ãƒ­ãƒƒã‚¯ä¸­ã¯ã‚¿ã‚¤ãƒãƒ¼ãŒé…å»¶/åœæ­¢ã™ã‚‹å ´åˆãŒã‚ã‚Šã¾ã™ã€‚å¿…è¦ã«å¿œã˜ã¦ <span class="kbd">è¨­å®š â†’ ç”»é¢è¡¨ç¤ºã¨æ˜ã‚‹ã• â†’ è‡ªå‹•ãƒ­ãƒƒã‚¯</span> ã‚’ã€Œã—ãªã„ã€ã«ã€‚å¯¾å¿œç«¯æœ«ã§ã¯Wake Lockã§ç”»é¢å¸¸æ™‚ONã«ã—ã¾ã™ã€‚</div>
        </div>
      </div>
      <div class="col">
        <div class="card panel">
          <h2>ãƒ™ãƒ«éŸ³è³ª</h2>
          <div class="controls">
            <label>éŸ³é‡</label>
            <input id="volume" type="range" min="0" max="1" step="0.01" value="0.6"/>
            <label>æ®‹éŸ¿(ç§’)</label>
            <input id="decay" type="range" min="0.2" max="8" step="0.1" value="2.5"/>
            <label>æ‰“æ•°</label>
            <select id="strike">
              <option value="1">1å›</option>
              <option value="2">2å›ï¼ˆçŸ­é–“éš”ï¼‰</option>
              <option value="3">3å›ï¼ˆçŸ­é–“éš”ï¼‰</option>
            </select>
          </div>
          <div class="chips"><span class="chip">MP3ï¼ˆWebAudioå†ç”Ÿï¼‰</span><span class="chip">ãƒ¦ãƒ¼ã‚¶ãƒ¼æ“ä½œã§è§£ç¦å¿…é ˆ</span></div>
        </div>
      </div>
    </div>
  </div>

  <footer>
    <div class="foot">
      <button class="btn" id="addToHomeHint">ï¼‹ ãƒ›ãƒ¼ãƒ ç”»é¢ã«è¿½åŠ ï¼ˆæ‰‹é †è¡¨ç¤ºï¼‰</button>
      <button class="btn" id="about">â„¹ ä½¿ã„æ–¹</button>
    </div>
  </footer>

<script>
(function(){
  const $ = (q)=>document.querySelector(q);
  const $$ = (q)=>Array.from(document.querySelectorAll(q));
  const fmt = (t)=>String(t).padStart(2,'0');

  // ---- Audio (WebAudio) ----
  let AC; let outputGain; let audioUnlocked = false;
  function ensureAudio(){
    if(!AC){ AC = new (window.AudioContext||window.webkitAudioContext)({latencyHint:'interactive'}); }
    if(!outputGain){ outputGain = AC.createGain(); outputGain.gain.value = parseFloat($('#volume').value); outputGain.connect(AC.destination); }
  }
  async function unlockAudio(){
    ensureAudio();
    try{ await AC.resume(); }catch(_){}
    // è§¦ã£ãŸå®Ÿç¸¾ï¼ˆiOSç”¨ãƒ»ç„¡éŸ³ã‚¯ãƒªãƒƒã‚¯ï¼‰
    const osc = AC.createOscillator();
    const g = AC.createGain(); g.gain.value = 0; osc.connect(g).connect(AC.destination); osc.start(); osc.stop(AC.currentTime+0.01);
    audioUnlocked = true; updateAudioState();
  }
  function updateAudioState(){ $('#audioState').textContent = audioUnlocked? 'ğŸ”Š Audio ready':'ğŸ”’ Audio locked'; }

  // ==== mp3 ã‚’ WebAudio ã§é³´ã‚‰ã™ç‰ˆ ====
  let bellBuffer = null;

  // mp3 ã‚’èª­ã¿è¾¼ã¿ï¼†ãƒ‡ã‚³ãƒ¼ãƒ‰ï¼ˆunlock å¾Œã«å‘¼ã¶ï¼‰
  async function loadBellMP3() {
    ensureAudio(); // AC ã‚’ç”¨æ„
    const res = await fetch('bell.mp3', { cache: 'force-cache' });
    if (!res.ok) throw new Error('bell.mp3 ãŒèª­ã¿è¾¼ã‚ã¾ã›ã‚“ã§ã—ãŸ');
    const arr = await res.arrayBuffer();
    bellBuffer = await AC.decodeAudioData(arr);
  }

  // å®Ÿéš›ã«é³´ã‚‰ã™ã€‚strike(æ‰“æ•°)ã€volumeã€é–“éš”(ç§’)ã¯UIã‹ã‚‰å–å¾—
  function bellPlay() {
    if (!bellBuffer) { console.warn('bellBuffer æœªãƒ­ãƒ¼ãƒ‰'); return; }

    const hit = parseInt($('#strike').value, 10);
    const vol = parseFloat($('#volume').value);
    const gap = 0.6; // 2æ‰“ç›®ä»¥é™ã®é–“éš”ï¼ˆç§’ï¼‰

    const now = AC.currentTime;
    for (let i = 0; i < hit; i++) {
      const src = AC.createBufferSource();
      src.buffer = bellBuffer;

      // å€‹åˆ¥ã®éŸ³é‡ã‚²ã‚¤ãƒ³
      const g = AC.createGain();
      g.gain.value = vol;
      src.connect(g).connect(AC.destination);

      // WebAudio ã®æ™‚é–“ã§æ­£ç¢ºã«ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒªãƒ³ã‚°
      src.start(now + i * gap);
    }
  }

  // éŸ³é‡ã‚¹ãƒ©ã‚¤ãƒ€å¤‰åŒ–æ™‚ï¼ˆå‡ºåŠ›ã‚²ã‚¤ãƒ³ã¯ä¸»ã«åˆæˆéŸ³ç”¨ã€‚mp3ã¯å€‹åˆ¥ã‚²ã‚¤ãƒ³ã§å¯¾å¿œï¼‰
  $('#volume').addEventListener('input',()=>{ ensureAudio(); if(outputGain) outputGain.gain.value=parseFloat($('#volume').value); });

  // ---- Wake Lock (Screen on) ----
  let wakeLockObj=null;
  async function requestWakeLock(){
    try{
      if('wakeLock' in navigator){
        wakeLockObj = await navigator.wakeLock.request('screen');
        wakeLockObj.addEventListener('release',()=>updateWakeLabel());
        updateWakeLabel();
      }
    }catch(e){ updateWakeLabel('failed'); }
  }
  function releaseWakeLock(){ if(wakeLockObj){ wakeLockObj.release().catch(()=>{}); wakeLockObj=null; updateWakeLabel(); } }
  function updateWakeLabel(state){
    const el=$('#wakeLockState');
    if(state==='failed'){ el.textContent='âš  Auto-Lock é˜²æ­¢å¤±æ•—'; return; }
    el.textContent = wakeLockObj? 'ğŸ”† Auto-Lock é˜²æ­¢ä¸­' : 'ğŸŒ™ Auto-Lock æœªé˜²æ­¢';
  }

  // ---- Schedule model ----
  /** Each entry: { whenMs: epochMillis, label: string, type: 'abs'|'offset' } */
  let schedule=[];

  function addOffset(min,sec){
    const t = Math.max(0,(min|0)*60 + (sec|0));
    const ms=t*1000;
    schedule.push({whenMs:ms,label:`+${fmt(min)}:${fmt(sec)}`,type:'offset'});
    renderSchedule();
  }
  function addAbsolute(timeStr){
    const [H,M] = timeStr.split(':').map(Number);
    const now = new Date();
    const dt = new Date(now.getFullYear(), now.getMonth(), now.getDate(), H, M, 0, 0);
    schedule.push({whenMs:dt.getTime(),label:`${fmt(H)}:${fmt(M)}`,type:'abs'});
    renderSchedule();
  }
  function renderSchedule(){
    const root = $('#scheduleList'); root.innerHTML='';
    schedule.forEach((it,idx)=>{
      const div=document.createElement('div'); div.className='item';
      const span=document.createElement('div');
      span.innerHTML = `<b>${it.label}</b> <small>${it.type==='offset'?'ã‚ªãƒ•ã‚»ãƒƒãƒˆ':'çµ¶å¯¾æ™‚åˆ»'}</small>`;
      const tools=document.createElement('div');
      const up=btn('â†‘', 'small', ()=>{ if(idx>0){ [schedule[idx-1],schedule[idx]]=[schedule[idx],schedule[idx-1]]; renderSchedule(); }});
      const down=btn('â†“','small',()=>{ if(idx<schedule.length-1){ [schedule[idx+1],schedule[idx]]=[schedule[idx],schedule[idx+1]]; renderSchedule(); }});
      const del=btn('å‰Šé™¤','small danger',()=>{ schedule.splice(idx,1); renderSchedule(); });
      tools.append(up,down,del);
      div.append(span,tools); root.append(div);
    });
    updateNextInfo();
  }
  function sortSchedule(){
    schedule.sort((a,b)=> a.whenMs - b.whenMs );
    renderSchedule();
  }
  function btn(txt, cls, on){ const b=document.createElement('button'); b.className='btn '+cls; b.textContent=txt; b.onclick=on; return b; }

  // ---- Presets (localStorage) ----
  const KEY='meditation_bell_presets_v1';
  function loadPresets(){ try{ return JSON.parse(localStorage.getItem(KEY)||'[]'); }catch(e){ return []; } }
  function savePresets(list){ localStorage.setItem(KEY, JSON.stringify(list)); }
  function renderPresets(){
    const list = loadPresets();
    const root = $('#presetList'); root.innerHTML='';
    if(!list.length){ root.innerHTML='<div class="item"><small>ä¿å­˜ãªã—</small></div>'; return; }
    list.forEach((p,idx)=>{
      const div=document.createElement('div'); div.className='item';
      const left=document.createElement('div');
      left.innerHTML=`<b>${p.name}</b><br><small>${p.data.length} é˜ / ${new Date(p.savedAt).toLocaleString()}</small>`;
      const tools=document.createElement('div');
      tools.append(
        btn('èª­è¾¼','small good',()=>{ schedule = p.data; renderSchedule(); $('#presetName').value=p.name; }),
        btn('åå‰å¤‰æ›´','small',()=>{ const nn=prompt('æ–°ã—ã„åå‰', p.name); if(nn){ const arr=loadPresets(); arr[idx].name=nn; savePresets(arr); renderPresets(); } }),
        btn('å‰Šé™¤','small danger',()=>{ const arr=loadPresets(); arr.splice(idx,1); savePresets(arr); renderPresets(); })
      );
      div.append(left,tools); root.append(div);
    });
  }

  $('#savePreset').onclick=()=>{
    const name = ($('#presetName').value||'ç„¡é¡Œ').trim();
    const list = loadPresets();
    const i = list.findIndex(p=>p.name===name);
    const data = schedule.map(x=>({...x}));
    const item = {name, data, savedAt: Date.now()};
    if(i>=0) list[i]=item; else list.unshift(item);
    savePresets(list); renderPresets();
  }
  $('#exportPreset').onclick=()=>{
    const payload = JSON.stringify({exportedAt:new Date().toISOString(), schedule, settings:getSettings()}, null, 2);
    const blob = new Blob([payload], {type:'application/json'});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url; a.download = 'meditation_bell_preset.json'; a.click();
    setTimeout(()=>URL.revokeObjectURL(url), 5000);
  }
  $('#importFile').addEventListener('change', (e)=>{
    const f=e.target.files[0]; if(!f) return;
    const reader = new FileReader();
    reader.onload=()=>{
      try{ const obj=JSON.parse(reader.result);
        if(Array.isArray(obj.schedule)){ schedule = obj.schedule; renderSchedule(); }
        if(obj.settings){ applySettings(obj.settings); }
      }catch(err){ alert('JSONã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸã€‚'); }
    };
    reader.readAsText(f);
  });

  function getSettings(){ return { volume: parseFloat($('#volume').value), decay: parseFloat($('#decay').value), strike: parseInt($('#strike').value,10) }; }
  function applySettings(s){ if(s.volume!=null) $('#volume').value=s.volume; if(s.decay!=null) $('#decay').value=s.decay; if(s.strike!=null) $('#strike').value=String(s.strike); if(outputGain) outputGain.gain.value=parseFloat($('#volume').value); }

  // ---- Session Engine ----
  let running=false, paused=false, startEpoch=0, elapsedBase=0, rafId=null, timers=[];

  function msToClock(ms){ const s=Math.max(0, Math.floor(ms/1000)); return `${fmt(Math.floor(s/60))}:${fmt(s%60)}`; }

  function updateClock(){ if(!running) return; const now=Date.now(); const elapsed = paused? elapsedBase : (elapsedBase + (now-startEpoch)); $('#clock').textContent = msToClock(elapsed); rafId = requestAnimationFrame(updateClock); }

  function scheduleTimers(){
    clearTimers();
    const now=Date.now();
    const resolved = schedule.map(it=>{
      if(it.type==='offset'){ return { at: now + it.whenMs, label: it.label }; }
      else { return { at: it.whenMs, label: it.label }; }
    }).filter(x=> x.at >= now );

    resolved.sort((a,b)=>a.at-b.at);

    resolved.forEach((r,i)=>{
      const delay = Math.max(0, r.at - now);
      const id = setTimeout(()=>{ bellPlay(); updateNextInfo(); }, delay);
      timers.push(id);
    });

    updateNextInfo(resolved);
  }

  function clearTimers(){ timers.forEach(id=>clearTimeout(id)); timers=[]; }

  function updateNextInfo(resolved){
    const root = $('#nextBellInfo'); root.innerHTML='';
    const now=Date.now();
    const list = resolved || schedule.map(it=>{
      if(it.type==='offset'){ return { at: now + it.whenMs, label: it.label }; }
      else { return { at: it.whenMs, label: it.label }; }
    }).filter(x=>x.at>=now).sort((a,b)=>a.at-b.at);

    if(!list.length){ root.innerHTML='<span class="chip">æ¬¡ã®ãƒ™ãƒ«ï¼šãªã—</span>'; return; }
    const next=list[0];
    const secs = Math.max(0, Math.round((next.at-now)/1000));
    root.innerHTML = `<span class="chip">æ¬¡ã®ãƒ™ãƒ«ï¼š${next.label}</span><span class="chip">ã‚ã¨ ${fmt(Math.floor(secs/60))}:${fmt(secs%60)}</span><span class="chip">æ®‹ã‚Š ${list.length} å›</span>`;
  }

  // Controls
  // ã€ŒéŸ³ã‚’è§£ç¦ã€ã§ AudioContext ã‚’è§£ç¦ã—ã¦ mp3 ã‚’ãƒ­ãƒ¼ãƒ‰
  $('#unlockAudio').onclick = async () => {
    await unlockAudio();
    if (!bellBuffer) {
      try { await loadBellMP3(); bellPlay(); }
      catch (e) { alert('ãƒ™ãƒ«éŸ³ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸã€‚bell.mp3 ã®é…ç½®ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚'); console.error(e); }
    } else {
      bellPlay();
    }
  };

  // ãƒ†ã‚¹ãƒˆãƒ™ãƒ«
  $('#testBell').onclick = async () => {
    if(!audioUnlocked) await unlockAudio();
    if (!bellBuffer) {
      try { await loadBellMP3(); } 
      catch (e) { alert('ãƒ™ãƒ«éŸ³ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸã€‚bell.mp3 ã®é…ç½®ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚'); return; }
    }
    bellPlay();
  };

  $('#start').onclick=()=>{
    if(!audioUnlocked){ alert('æœ€åˆã«ã€ŒéŸ³ã‚’è§£ç¦ã€ã‚’ã‚¿ãƒƒãƒ—ã—ã¦ãã ã•ã„ã€‚'); return; }
    if(!bellBuffer){ alert('ãƒ™ãƒ«éŸ³ãŒæœªãƒ­ãƒ¼ãƒ‰ã§ã™ã€‚éŸ³ã‚’è§£ç¦â†’ãƒ†ã‚¹ãƒˆã§ç¢ºèªã—ã¦ã­ã€‚'); return; }
    running=true; paused=false; startEpoch=Date.now(); updateClock(); requestWakeLock(); scheduleTimers();
  };
  $('#pause').onclick=()=>{
    if(!running) return; paused = !paused; if(paused){ elapsedBase += Date.now()-startEpoch; } else { startEpoch = Date.now(); }
  };
  $('#stop').onclick=()=>{ running=false; paused=false; cancelAnimationFrame(rafId); $('#clock').textContent='00:00'; elapsedBase=0; clearTimers(); releaseWakeLock(); updateNextInfo(); };

  // Schedule UI events
  $('#addOffset').onclick=()=>{
    const m = parseInt($('#mm').value||'0',10); const s=parseInt($('#ss').value||'0',10); if(isNaN(m)||isNaN(s)) return; addOffset(m,s); $('#mm').value=''; $('#ss').value='';
  };
  $('#genEvery').onclick=()=>{
    const minStr = prompt('é–“éš”ï¼ˆåˆ†ï¼‰ä¾‹: 5'); if(minStr==null) return; const mins=parseFloat(minStr);
    const countStr= prompt('å›æ•° ä¾‹: 6'); if(countStr==null) return; const cnt=parseInt(countStr,10);
    if(!(mins>0 && cnt>0)) return; for(let i=1;i<=cnt;i++){ addOffset(mins*i,0); }
  };
  $('#addAbs').onclick=()=>{ const t=$('#absTime').value; if(!t) return; addAbsolute(t); };
  $('#clearSchedule').onclick=()=>{ if(confirm('ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ã‚’å…¨ã¦å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')){ schedule=[]; renderSchedule(); } };
  $('#sortSchedule').onclick=sortSchedule;

  // Footer actions
  $('#about').onclick=()=>{
    alert('â‘  ä¸Šã§ãƒ™ãƒ«æ™‚åˆ»ã‚’è¿½åŠ ï¼ˆã‚ªãƒ•ã‚»ãƒƒãƒˆ/çµ¶å¯¾ï¼‰ã€‚\nâ‘¡ å¿…è¦ãªã‚‰ãƒ—ãƒªã‚»ãƒƒãƒˆåã‚’ä»˜ã‘ã¦ä¿å­˜ã€‚\nâ‘¢ ã€ŒéŸ³ã‚’è§£ç¦ã€â†’ã€Œé–‹å§‹ã€ã€‚\nâ€» iOSã¯ç”»é¢ãƒ­ãƒƒã‚¯ä¸­ã«ã‚¿ã‚¤ãƒãƒ¼ãŒé…å»¶/åœæ­¢ã™ã‚‹å ´åˆãŒã‚ã‚Šã¾ã™ã€‚å¿…è¦ã«å¿œã˜ã¦Auto-Lockç„¡åŠ¹ã‚„ã€å¯¾å¿œç«¯æœ«ã§ã¯Wake Lockã‚’åˆ©ç”¨ã—ã¦ãã ã•ã„ã€‚');
  };
  $('#addToHomeHint').onclick=()=>{
    alert('ãƒ›ãƒ¼ãƒ ç”»é¢ã«è¿½åŠ æ‰‹é †:\n1) å…±æœ‰ãƒœã‚¿ãƒ³ â†’ ã€Œãƒ›ãƒ¼ãƒ ç”»é¢ã«è¿½åŠ ã€ã€‚\n2) è¿½åŠ å¾Œã¯ãƒ•ãƒ«ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ã§èµ·å‹•ã§ãã¾ã™ã€‚');
  };

  // init
  renderPresets(); renderSchedule(); updateAudioState(); updateWakeLabel();
  document.addEventListener('visibilitychange',()=>{ if(document.visibilityState==='visible' && running){ requestWakeLock(); } });
})();
</script>
</body>
</html>
